---
name: wtp-cleanup
description: "wtpコマンドでマージ済みワークツリーを検出して一括削除する。`wtp list`で一覧取得し、mainにマージ済みのブランチを判定して`wtp rm`で削除する。"
user-invocable: true
---

# マージ済みワークツリーのクリーンアップ

## 概要

`wtp list` で取得したワークツリーのうち、`main` ブランチにマージ済みのものを検出し、ユーザー確認の上で一括削除します。

## 実行手順

### 1. ワークツリー一覧の取得

```bash
wtp list
```

### 2. フルブランチ名の取得

`wtp list` の出力はブランチ名が省略される場合があるため、`git worktree list --porcelain` でフルネームを取得します。

```bash
git worktree list --porcelain | grep 'branch'
```

### 3. マージ済みブランチの判定

```bash
git branch --merged main
```

ステップ2で取得した各ブランチ名が、このマージ済みリストに含まれるかを照合します。
`main` ブランチ自体はクリーンアップ対象から除外してください。

### 4. 結果の報告と削除確認

マージ済み・未マージのブランチをテーブル形式で一覧表示し、削除対象を明示します。
その後、`AskUserQuestion` ツールを使用して、マージ済みワークツリーを削除してよいかユーザーに確認してください。

### 5. マージ済みワークツリーの削除

ユーザーが承認した場合のみ、`wtp rm` で一括削除を実行してください。

```bash
wtp rm <BRANCH_1> && wtp rm <BRANCH_2> && ...
```

### 6. エラーハンドリング

- 未コミットの変更やuntrackedファイルがあるワークツリーは削除に失敗します
- 失敗した場合は `AskUserQuestion` ツールを使用して、`--force` フラグでの強制削除を行うかユーザーに確認してください
- ユーザーが承認した場合のみ `wtp rm <BRANCH> --force` で強制削除を実行してください

### 7. 削除後の確認

```bash
wtp list
```

削除後のワークツリー一覧を表示し、残っているワークツリーを報告してください。
